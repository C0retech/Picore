<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Interactive Knowledge Map Editor</title>
  <script src="https://unpkg.com/cytoscape@3.25.2/dist/cytoscape.min.js"></script>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#1e1e2f; color:white; }
    #cy { width: 100%; height: 80vh; display:block; border-bottom: 2px solid #444; }
    .controls {
      padding: 10px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      background:#2a2a3d;
    }
    .controls input, .controls select, .controls button {
      padding: 5px;
      border-radius:5px;
      border:none;
      font-size: 14px;
    }
    .controls button { background:#ff4081; color:white; cursor:pointer; }
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      pointer-events: none;
      display: none;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div id="cy"></div>

<div class="controls">
  <!-- Lägg till nod -->
  <input id="nodeLabel" placeholder="Nod namn">
  <input id="nodeInfo" placeholder="Info om noden">
  <button id="addNodeBtn">Add Node</button>

  <!-- Lägg till edge -->
  <select id="edgeSource"><option value="">Source</option></select>
  <select id="edgeTarget"><option value="">Target</option></select>
  <button id="addEdgeBtn">Add Edge</button>
</div>

<div id="tooltip" class="tooltip"></div>

<script>
  // Ladda graf från localStorage om den finns
  let savedGraph = JSON.parse(localStorage.getItem('graph')) || { nodes: [], edges: [] };

  const cy = cytoscape({
    container: document.getElementById('cy'),
    elements: savedGraph,
    style: [
      {
        selector: 'node',
        style: {
          'label': 'data(label)',
          'text-valign': 'center',
          'text-halign': 'center',
          'background-color': '#ff4081',
          'color': 'white',
          'font-size': '14px',
          'width': '60px',
          'height': '60px'
        }
      },
      {
        selector: 'edge',
        style: {
          'width': 3,
          'line-color': '#00bcd4',
          'target-arrow-color': '#00bcd4',
          'target-arrow-shape': 'triangle',
          'curve-style': 'bezier'
        }
      }
    ],
    layout: { name: 'cose', animate: true }
  });

  const tooltip = document.getElementById('tooltip');

  // Tooltip
  cy.on('mouseover', 'node', function(evt){
    const node = evt.target;
    tooltip.style.display = 'block';
    tooltip.innerText = node.data('info');
  });
  cy.on('mousemove', function(evt){
    tooltip.style.left = (evt.originalEvent.clientX + 10) + 'px';
    tooltip.style.top = (evt.originalEvent.clientY + 10) + 'px';
  });
  cy.on('mouseout', 'node', function(){
    tooltip.style.display = 'none';
  });

  // Hjälpfunktion för att uppdatera dropdowns
  function updateEdgeDropdowns() {
    const source = document.getElementById('edgeSource');
    const target = document.getElementById('edgeTarget');
    source.innerHTML = '<option value="">Source</option>';
    target.innerHTML = '<option value="">Target</option>';
    cy.nodes().forEach(node => {
      const option = `<option value="${node.id()}">${node.data('label')}</option>`;
      source.innerHTML += option;
      target.innerHTML += option;
    });
  }

  updateEdgeDropdowns();

  // Lägg till nod
  document.getElementById('addNodeBtn').addEventListener('click', () => {
    const label = document.getElementById('nodeLabel').value.trim();
    const info = document.getElementById('nodeInfo').value.trim();
    if(!label) return alert('Nod namn krävs!');
    const id = 'node_' + Date.now();
    cy.add({ data: { id, label, info } });
    cy.layout({ name: 'cose', animate:true }).run();
    updateEdgeDropdowns();
    saveGraph();
    document.getElementById('nodeLabel').value = '';
    document.getElementById('nodeInfo').value = '';
  });

  // Lägg till edge
  document.getElementById('addEdgeBtn').addEventListener('click', () => {
    const source = document.getElementById('edgeSource').value;
    const target = document.getElementById('edgeTarget').value;
    if(!source || !target) return alert('Välj både source och target!');
    cy.add({ data: { source, target } });
    cy.layout({ name: 'cose', animate:true }).run();
    saveGraph();
    updateEdgeDropdowns();
  });

  // Spara graf till localStorage
  function saveGraph() {
    const elements = cy.json().elements;
    localStorage.setItem('graph', JSON.stringify(elements));
  }

</script>
</body>
</html>
